---
title: "Transform"
author: "Ben Denis Shaffer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Transform}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r message=FALSE, warning=FALSE}
library(mmmactive)
library(tidyverse)

nmp <- "ttn"
rgn <- c("CR", "MAR", "MTN", "MWR", "NER", "NWR", "SER", "WR")

input_file_ModelSetup =  here::here("data","ttn-ModelSetup.csv")
input_file_ModelSpec = here::here("data","ttn-ModelSpec.csv")

input_file_ModelData = here::here("data","ModelData.xlsx")
input_file_FMIData = here::here("data","FMI.csv")
input_file_MSRPData <- here::here("data","MSRPData.csv")
input_file_SpendData <- here::here("data","SpendData.csv")

input_files = list(
  input_file_ModelData = input_file_ModelData,
  input_file_FMIData = input_file_FMIData,
  input_file_SpendData = input_file_SpendData,
  input_file_MSRPData = input_file_MSRPData
)


mod_obj <- create_mod_obj()
mod_obj <- mod_obj %>% 
  activate_model_setup(input_file_ModelSetup) %>%
  activate_model_spec(input_file_ModelSpec) %>% 
  add_group_selector(vehicles = nmp, regions = rgn) %>%
  Load_Data(input_files)

is.transform_ready(mod_obj)
```

### Fit Curves for AdResponse

For the Response transformations that we commonly use we need an additional piece if data before the `mod_obj` becomes transform_ready. We need to the fit curves. These are added on in a similar fashion as other data elements.

In the future fit curves should only be requested if AdResponse transfromations are detected in the spec file.

```{r}
input_FitCurves <- here::here("data","Fit_Curves.xlsx")
mod_obj <- Load_FitCurves(mod_obj, input_FitCurves)

is.transform_ready(mod_obj)
```


# `Transform` Highe-Level Function

Setting            | No Monthly and Weekly | Yes Monthly and Weekly
------------------ | --------------------- | ----------------------
No Corss-Section   | none                  | Temp - Join
Yes Corss-Section  | Split                 | Temp - Split - Join


## Sielently
```{r warning=FALSE, message=FALSE}
mod_obj <- Transform(mod_obj, print = FALSE)
```

## Transfromed Data


### Monthly Level 
```{r}
glimpse(mod_obj$data_transformed$monthly)
```


### Monthly Level 
```{r}
glimpse(mod_obj$data_transformed$weekly)
```


### Combined Data 
```{r}
glimpse(mod_obj$data)
```

## Verbose
```{r warning=FALSE, message=FALSE}
mod_obj <- Transform(mod_obj)
```

# Intermediate Functions

* TransformTemp and TransformTempJoin
* TransformSplit

# `TransformVar` Low-Level Function


The low level transformation function is the `TransformVar` function. This function takes a data vector from the `mod_obj$data_input` that is specified in the Model Spec as it's first argument. This is how the function is used within the high-level `Transfrom` function, however you can supply any data vector

Here is an example of how `TransformVar` operates on a `mod_obj`

```{r}

data_vector = mod_obj$data_input$weekly[["tv_e_eeq_direct_t2"]]
transfromation_instruction = mod_obj$spec[mod_obj$spec$Orig_Variable == "tv_e_eeq_direct_t2",]
as.data.frame(transfromation_instruction)
```

```{r}
data_vector_transformed = 
  TransformVar(data_vector = data_vector,
               spec_row = transfromation_instruction,
               fit_curves = mod_obj$fit_curves)
```


```{r}
plot(data_vector, data_vector_transformed)
```

Here is an example of how `TransformVar` can be given any vector, here numbers from 1-200. We keep the same transofrmation instructions as in the above.

```{r}
data_vector = 1:200
transfromation_instruction = mod_obj$spec[mod_obj$spec$Orig_Variable == "tv_e_eeq_direct_t2",]

data_vector_transformed = 
  TransformVar(data_vector = data_vector,
               spec_row = transfromation_instruction,
               fit_curves = mod_obj$fit_curves,
               print = FALSE)

plot(data_vector, data_vector_transformed)
```



# Supported Transfomration Functions

### "ADSTOCK" - `AdStockPD(data_vector, Decay, Period)`

###  "ADR" - `AdResponse(data_vector, fit_curves, c(Effective, Recency, Period, Decay))`

###  "ADSTOCKV3" - `adstockv3(data_vector, Decay, Peak, Length)`

###  "LAG" - `lag(data_vector, Lag, default = 0)`

###  "LOG" - `log(data_vector * Scale + 1)`

###  "POLY" - `myPoly(data_vector, Alpha)`

### "STEIN" - `shrinker(data_vector, bw = Window, trim = Trim)`

###  "CPT - `cpt.meanvar(data_vector, minseglen = 6, penalty = "CROPS", pen.value = c(0, 100), method = "PELT")`

###  "POWER" - `(data_vector)^Power`

###  "NONE" - `data_vector`



